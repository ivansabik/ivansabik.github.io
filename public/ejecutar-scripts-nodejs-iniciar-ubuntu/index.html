<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Ejecutar scripts node.js al iniciar ubuntu - sabikulous
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Press+Start+2P">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Inconsolata">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Ejecutar scripts node.js al iniciar ubuntu</h1>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>Node.js es famoso por sus callback y su enfoque orientado eventos lo que se presta para usarlo para ejecutar scripts o programitas desarrollados con Javascript. Recientemente quize saber cuándo publicarían la convocatoria para el premio de la Antonio Minzoni de la <span class="caps">CNSF</span> y pensé que sería mejor tener un servicio que avisar por correo electrónico si se publicó la página con la&nbsp;convocatoria.</p>
<p>Otra cosa interesante de Node.js es el extenso número de librerías que existen disponibles a través de npm además que es muy sencillo configurar las&nbsp;dependecias. </p>
<h3 id="requisitos">Requisitos</h3>
<p>Node.js y npm instalados, la forma más fácil en ubuntu&nbsp;es:</p>
<pre><code class="lang-bash">$ <span class="built_in">sudo</span> apt-get install nodejs
$ <span class="built_in">sudo</span> apt-get install npm
</code></pre>
<p>Luego las dependencias con&nbsp;npm:</p>
<pre><code class="lang-bash">$ npm install nodemailer
$ npm install nodemailer-smtp-transport
$ npm install request
</code></pre>
<p>Para saber si ya se publicó la convocatoria, se puede usar un programa que se ejecute periódicamente o al iniciar la compu (que es este caso). Para esto voy a usar <a href="https://github.com/chovy/node-startup/blob/master/init.d/node-app">node-startup</a>. </p>
<p>Primero hay que crear el archivo <code>/etc/init.d/alerta-cnsf</code> y copiar el contenido del template de node-app. Este archivo contendrá un código sh (shell, bash) que ejecutará el script en Node.js al inicio. El mío quedó <a href="https://gist.github.com/ivansabik/cd70ca34e82403c66781">algo así</a>, los programines en javascript se guardarán en&nbsp;“home/scripts-startup”:</p>
<pre><code class="lang-bash"><span class="shebang">#!/bin/sh
</span>
NODE_ENV=<span class="string">"production"</span>
<span class="caps">PORT</span>=<span class="string">"3000"</span>
APP_DIR=<span class="string">"~/scripts-startup"</span>
NODE_APP=<span class="string">"cnsf.js"</span>
...
...
</code></pre>
<p>Luego hay que actualizar&nbsp;con:</p>
<pre><code>$ update-rc.d node-startup defaults
</code></pre><h3 id="el-script-de-java-javascript">El <del>script de java</del> javascript</h3>
<p>En convocatorias anteriores, las publicaciones y los resultados están&nbsp;en:</p>
<ul>
<li><a href="http://www.cnsf.gob.mx/Eventos/Paginas/Premios_2012.aspx">http://www.cnsf.gob.mx/Eventos/Paginas/Premios_2012.aspx</a></li>
<li><a href="http://www.cnsf.gob.mx/Eventos/Paginas/Premios_2013.aspx">http://www.cnsf.gob.mx/Eventos/Paginas/Premios_2013.aspx</a></li>
<li><a href="http://www.cnsf.gob.mx/Eventos/Paginas/Premios_2014.aspx">http://www.cnsf.gob.mx/Eventos/Paginas/Premios_2014.aspx</a></li>
</ul>
<p>Entonces la idea es hacer una petición <span class="caps">HTTP</span> a <a href="http://www.cnsf.gob.mx/Eventos/Paginas/Premios_2015.aspx">http://www.cnsf.gob.mx/Eventos/Paginas/Premios_2015.aspx</a> esperando que ahí se publique. Esto se puede hacer por medio de las repuestas <span class="caps">HTTP</span> comunes (200 para ok y 400 para no encontrado) Entonces hay que crear el archivo&nbsp;“~/scripts-startup/cnsf.js”.</p>
<h4 id="-scripts-startup-cnsf-js">~/scripts-startup/cnsf.js</h4>
<script src="https://gist.github.com/ivansabik/bc4ed7f2cc4ad118eb8d.js"></script>

<h4 id="probando-que-funciona">Probando que&nbsp;funciona</h4>
<p>Listo, si todo salió bien al reiniciar, se ejecutará el javascript pero podemos ver si funciona ejecutándolo como cualquier otro programa de&nbsp;Node.js:</p>
<pre><code class="lang-bash">$ node ~/scripts-startup/cnsf.js
-------------------------
Tue Apr <span class="number">07</span> <span class="number">2015</span> <span class="number">03</span>:<span class="number">11</span>:<span class="number">08</span> <span class="caps">GMT</span>-<span class="number">0500</span> (<span class="caps">CDT</span>)
Iniciando cnsf.js...
Intento <span class="number">1</span>
Tue Apr <span class="number">07</span> <span class="number">2015</span> <span class="number">03</span>:<span class="number">11</span>:<span class="number">08</span> <span class="caps">GMT</span>-<span class="number">0500</span> (<span class="caps">CDT</span>)
Pagina http://www.cnsf.gob.mx/Eventos/Paginas/Premios_2015.aspx responde <span class="string">"404"</span>
</code></pre>
<p>Y para probar que funciona el envío del correo se cambia temporalmente esta&nbsp;línea:</p>
<pre><code class="lang-javascript"><span class="keyword">if</span>(res.statusCode === <span class="number">200</span>) {
</code></pre>
<p>Por:</p>
<pre><code class="lang-javascript"><span class="keyword">if</span>(res.statusCode) {
</code></pre>
<p>Y al volver a correr el&nbsp;script:</p>
<pre><code class="lang-bash">$ node ~/scripts-startup/cnsf.js
-------------------------
Tue Apr <span class="number">07</span> <span class="number">2015</span> <span class="number">03</span>:<span class="number">22</span>:<span class="number">04</span> <span class="caps">GMT</span>-<span class="number">0500</span> (<span class="caps">CDT</span>)
Iniciando cnsf.js...
Intento <span class="number">1</span>
Enviando mail
Enviado!
Respuesta <span class="string">"250 2.0.0 <span class="caps">OK</span> 1428394926 c41sm5809909yhc.53 - gsmtp"</span>
</code></pre>
<p><img src="/public/ejecutar-scripts-nodejs-iniciar-ubuntu/mail-alerta-cnsf.png" alt="Mail de alerta"></p>
<p>¡Y sí son las tres de la mañana entonces ya no voy a corregir el&nbsp;“Convocatorioa”!</p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">« portada</a></div>
        <section class="copy">
          <p>&copy; 2015 sabik @ mandroslabs &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>